<!DOCTYPE html>
<html>
	<head>
		<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
		<title>Ruby on Rails 实战圣经 | Rails 起步走</title>
		<link rel="stylesheet" type="text/css" href="./style.css">
		<link rel="canonical" href="https://ihower.tw/rails4/firststep.html">
	</head>
<body>
<div class="container">
    <div class="page_header">
        <h1 class="logo"><a href="./index.html">Ruby on Rails 实战圣经<span>使用 Rails 4.2 及 Ruby 2.1</span></a></h1>
        <div class="search_box">
            <form class="search" action="https://www.google.com/search">
            <input type="hidden" value="ihower.tw/rails4" name="as_sitesearch">
            <input class="search_field" type="text" value="" name="as_q">
            <input class="search_btn" type="submit" value="Search">
            </form>
        </div>
    </div>

    <div class="notice">
    <p class="inner info_bubble">
      <a href="https://leanpub.com/ihower-rails-book">电子书</a>和简体版本准备中。如果您有任何意见、鼓励或勘误，欢迎<a href="mailto:ihower@gmail.com">来信给我</a>，谢谢。
    </p>
    </div>

    <div class="inner wrap">
       <div class="sidebar">
            <h3><a href="about.html">关于本书</a></h3>
            <h3><a href="index.html">回首页</a></h3>
            <p>本书的原作者是ihower，原为繁体版本，详见<a href="https://ihower.tw/rails4/index.html">这里</a>。我只是改成了简体。谢谢ihower的努力，写出了这么优秀的教程！</p>
       </div>
       <div class="content body">
	      <h1 id="rails-">Rails 起步走</h1>

<blockquote>
  <p>There are two ways of constructing a software design: One way is to make it so simple that there are obviously no deficiencies and the other way is to make it so complicated that there are no obvious deficiencies. - C.A.R. Hoare,</p>
</blockquote>

<p>在这一章中，我们将开始介绍如何建立一个最简单的<em>Hello, World!</em>程式，以及用最快速的方式制作<em>CRUD</em>应用。</p>

<blockquote>
  <p><em>CRUD</em>指的是<em>Create</em>(新增)、<em>Read</em>(读取)、<em>Update</em>(更新)、<em>Delete</em>(删除)四种操作资料的基本方式。</p>
</blockquote>

<p>在上一章安装<em>Rails</em>后，你会在命令行中得到一个<code>rails</code>的指令，这个指令可以初始一个<em>Rails</em>项目目录。</p>

<h2 id="rails">开始建立第一个<em>Rails</em>应用程序</h2>

<p>首先请打开一个命令行窗口<em>(Terminal)</em>，然后找个目录适合放你的<em>Rails</em>项目，就说是<code>projects</code>好了：</p>

<pre><code>$ mkdir projects
$ cd projects
</code></pre>

<p>接着，输入以下指令就会建立一个叫做<em>demo</em>的<em>Rails</em>项目：</p>

<pre><code>$ rails new demo --skip-test-unit
</code></pre>

<blockquote>
  <p>如果出现建立出来的目录不是<em>demo</em>而是<em>new</em>，表示你的<em>Rails</em>版本是旧版的，请输入<code>rails -v</code>检查<em>Rails</em>的版本必须是<em>3.0</em>以上。不是的话，请回上一章末执行<code>gem install rails</code>安装<em>Rails 4</em>。</p>
</blockquote>

<p>你会看到以下信息显示出总共新增了哪些档案：</p>

<pre><code>create
create  README
create  Rakefile
create  config.ru
create  .gitignore
create  Gemfile
create  app
...(略)...
create  vendor/plugins
create  vendor/plugins/.gitkeep
</code></pre>

<p>这样就建立出<em>demo</em>目录，让我们继续：</p>

<pre><code>$ cd demo
</code></pre>

<p>这个目录下包含了一个<em>Rails</em>项目基本会用到的目录结构和档案，让我们简单走访一下，输入<code>ls</code><em>(Windows读者请输入dir)</em>显示出此目录下的档案：</p>

<table>
  <tr>
    <th>档案/目录</th>
    <th>用途</th>
  </tr>
  <tr>
    <td>Gemfile</td>
    <td>设定Rails应用程序会使用哪些Gems套件</td>
  </tr>
  <tr>
    <td><span class="caps">README</span></td>
    <td>项目说明：你可以用来告诉其他人你的应用程序是做什么用的，如何使用等等。 </td>
  </tr>
  <tr>
    <td>Rakefile</td>
    <td>用来载入可以被命令行执行的一些Rake任务</td>
  </tr>
  <tr>
    <td>app/</td>
    <td>放Controllers、Models和Views档案，接下来的内容主要都在这个目录。</td>
  </tr>
  <tr>
    <td>config/</td>
    <td>应用程序设定档、路由规则、数据库设定等等</td>
  </tr>
  <tr>
    <td>config.ru</td>
    <td>用来启动应用程序的Rack服务器设定档</td>
  </tr>
  <tr>
    <td>db/</td>
    <td>数据库的结构纲要</td>
  </tr>
  <tr>
    <td>doc/</td>
    <td>用来放你的文件</td>
  </tr>
  <tr>
    <td>lib/</td>
    <td>放一些自定的Module和类别档案</td>
  </tr>
  <tr>
    <td>log/</td>
    <td>应用程序的Log记录档</td>
  </tr>
  <tr>
    <td>public/</td>
    <td>唯一可以在网络上看到的目录，这是你的图档、JavaScript、CSS和其他静态档案摆放的地方 </td>
  </tr>
  <tr>
    <td>bin/</td>
    <td>放rails这个指令和放其他的script指令</td>
  </tr>
  <tr>
    <td>test/</td>
    <td>单元测试、fixtures及整合测试等程式</td>
  </tr>
  <tr>
    <td>tmp/</td>
    <td>暂时性的档案</td>
  </tr>
  <tr>
    <td>vendor/</td>
    <td>用来放第三方程式码外挂的目录</td>
  </tr>
</table>

<h2 id="section">启动服务器</h2>

<p><em>Rails</em>使用了一套叫做<em>Bundler</em>的工具可以帮助我们检查及安装这个<em>Rails</em>应用程序所有依赖的套件，请输入：</p>

<pre><code>$ bundle install
</code></pre>

<blockquote>
  <p>可以只输入<code>bundle</code>就是<code>bundle install</code>了。
每次有修改<em>Gemfile</em>这个档案，都需要重新执行<code>bundle</code></p>
</blockquote>

<p>会出现</p>

<pre><code>Fetching source index for http://rubygems.org/
...
Your bundle is complete! Use `bundle show [gemname]` to see where a bundled gem is installed.
</code></pre>

<p>在开发用的电脑上，我们不需要安装如<em>Apache</em>、<em>IIS</em>的网站服务器。<em>Ruby</em>本身就有提供了<em>HTTP</em>服务器可以执行<em>Rails</em>，要启动它，我们另开启一个指令窗口，<em>cd</em>进到刚刚建立的<em>Rails</em>项目目录然后输入<em>bin/rails server</em>：</p>

<pre><code>$ cd projects/demo
$ bin/rails server
</code></pre>

<p>就会出现以下信息：</p>

<pre><code>=&gt; Booting WEBrick
=&gt; Rails 4.2.0 application starting in development on http://0.0.0.0:3000
=&gt; Run `rails server -h` for more startup options
=&gt; Notice: server is listening on all interfaces (0.0.0.0). Consider using  127.0.0.1 (--binding option)
=&gt; Ctrl-C to shutdown server
[2014-10-21 21:38:39] INFO  WEBrick 1.3.1
[2014-10-21 21:38:39] INFO  ruby 2.1.5p273 (2014-11-13) [x86_64-darwin13.0]
[2014-10-21 21:38:39] INFO  WEBrick::HTTPServer#start: pid=42535 port=3000
</code></pre>

<blockquote>
  <p>rails server 可以简写为 rails s</p>
</blockquote>

<blockquote>
  <p>使用<em>Ubuntu</em>操作系统的朋友，如果启动服务器时出现<em>Could not find a JavaScript runtime</em>的错误，请编辑<em>Gemfile</em>这个档案加上一行<code>gem 'therubyracer'</code>，输入<code>bundle install</code>安装这个套件，然后再启动一次<code>rails server</code>即可。这是因为在<em>Ubuntu</em>操作系统上预设没有任何<em>JavaScript</em>直译器可以给<em>Rails</em>使用。你可以装<em>Node.js</em>或是安装<em>therubyracer</em>这个<em>Ruby</em>套件来获得<em>JavaScript</em>直译器。</p>
</blockquote>

<p>接着打开你的浏览器前往<em><a href="http://localhost:3000">http://localhost:3000</a></em>，我们可以看到<em>Rails</em>的预设首页。这个<em>Welcome Aboard</em>的画面可以确认设定无误，点选<em>About your application’s environment</em>超链接可以看到更多环境信息。</p>

<p><img src="images/firststep-welcome-screenshot.png" alt="Welcome screenshot"></p>

<p>要中断服务器的话，请按<em>Ctrl+C</em>(若不灵光请改试<em>Ctrl+Z</em>)。在<em>development</em>开发模式的话，除了修改<em>config</em>或<em>vender</em>目录下的档案需要重新启动之外，其他修改通常不需要重新启动，修改的档案会自动重新载入。如果是 <em>production</em>正式上线模式的话，修改任何档案都必须重新启动服务器才会有效果。</p>

<h2 id="hello-world">第一个<em>Hello World!!</em>
</h2>

<p>让程式说<em>Hello World!</em>可是我们学写程式的一大传统。我们提过<em>Rails</em>是<em>MVC</em>框架，显示<em>Hello World!</em>不需要用到数据库，所以我们只要先写<em>Controller</em>和<em>View</em>，以及让路由指派到这个<em>Controller</em>即可，输入以下指令就会产生出一个叫做<em>welcome</em>的空<em>Controller</em>档案：</p>

<pre><code>$ bin/rails generate controller welcome
</code></pre>

<blockquote>
  <p>可以简写为<code>bin/rails g controller welcome</code></p>
</blockquote>

<p>接下来在路由档案<em>config/routes.rb</em>新增一行设定：</p>

<pre><code>Rails::Application.routes.draw do
  get "welcome/say_hello" =&gt; "welcome#say"
  # ...
end
</code></pre>

<p><code>get</code>这一行的意思是将<code>http://localhost:3000/welcome/say_hello</code>这样的网址对应到<em>welcome Controller</em>的<em>say Action</em>。</p>

<p>编辑<em>app/controllers/welcome_controller.rb</em>，加入一个<code>say</code>方法：</p>

<pre><code>class WelcomeController &lt; ApplicationController
  def say
  end
end
</code></pre>

<p>在<em>Controller</em>中，一个公开函数<em>(public method)</em>就代表一个<em>Action</em>，一个<em>Action</em>对应一个<em>HTTP</em>的请求和回应。接着我们打开浏览器浏览<em>http://localhost:3000/welcome/say_hello</em>，你会看到一个错误如下：</p>

<pre><code>Missing template welcome/say, application/say with {:locale=&gt;[:en], :formats=&gt;[:html], :variants=&gt;[], :handlers=&gt;[:erb, :builder, :raw, :ruby, :coffee, :jbuilder]}. Searched in: * "/Users/ihower/projects/demo/app/views"
</code></pre>

<p>这是因为我们还没有准备好<em>View</em>档案。请新增<em>app/views/welcome/say.html.erb</em>这个档案，依照惯例目录名就是<em>Controller</em>名称、档案名是<em>Action</em>名称，第一个附档名说明了这是<em>HTML</em>格式的档案，第二个附档名说明这是<em>ERb</em>样板(我们会在<em>View</em>一章仔细介绍样板)。编辑该档案内容如下：</p>

<pre><code>&lt;h1&gt;Hello, World!&lt;/h1&gt;
</code></pre>

<p>这时再重新整理一次浏览器，你就会看到<em>Hello, World!</em>了。</p>

<p>让我们再新增一个页面并加入超链接。再次编辑路由档案<em>config/routes.rb</em>加入一个路由，变成这样：</p>

<pre><code>Rails::Application.routes.draw do
  get "welcome/say_hello" =&gt; "welcome#say"
  get "welcome" =&gt; "welcome#index"
  # ...
end
</code></pre>

<p>这一行的意思是将<code>http://localhost:3000/welcome</code>这样的网址对应到<em>welcome Controller</em>的<em>index Action</em>。
编辑<em>app/controllers/welcome_controller.rb</em>加入</p>

<pre><code>class WelcomeController &lt; ApplicationController

  #...

  def index
  end
end
</code></pre>

<p>新增<em>app/views/welcome/index.html.erb</em>内容是</p>

<pre><code>&lt;p&gt;Hola! It's &lt;%= Time.now %&gt;&lt;/p&gt;
&lt;p&gt;&lt;%= link_to 'Hello!', welcome_say_hello_path %&gt;&lt;/p&gt;
</code></pre>

<p><code>Time</code>是<em>Ruby</em>内建的时间类别，<code>Time.now</code>会输出目前时间。<code>link_to</code>是<em>Rails</em>内建的方法可以输出超链接，而<em>welcome_say_hello_path</em>会输出<code>/welcome/say_hello</code>这个网址。这种出现在<em>View</em>中的辅助方法统称作<em>Helper</em>。浏览<em>http://localhost:3000/welcome</em>，将看到<em>Hola!</em>及<em>Hello!</em>超链接。</p>

<p><img src="images/firststep-hello-screenshot.png" alt="Hello screenshot"></p>

<h3 id="section-1">设定首页</h3>

<p>如何将网站首页变更为<em>welcome#index</em>呢？编辑<em>config/routes.rb</em>，加上以下的程式码，变成这样：</p>

<pre><code>Rails::Application.routes.draw do
  get "welcome/say_hello" =&gt; "welcome#say"
  get "welcome" =&gt; "welcome#index"

  root :to =&gt; "welcome#index"
  # ...
end
</code></pre>

<blockquote>
  <p><em>Ruby</em>的单行註解是用<code>#</code>井号</p>
</blockquote>

<p>这一行的意思是，将网站根目录导引至<em>welcome Controller</em>的<em>index Action</em>。那在<em>View</em>中要怎麼建立回首页的链接呢？编辑<em>app/views/welcome/say.html.erb</em>在Hello, World!下一行加入：</p>

<pre><code>&lt;h1&gt;Hello, World!&lt;/h1&gt;
&lt;p&gt;&lt;%= link_to "Home", root_path %&gt;&lt;/p&gt;
</code></pre>

<p>如此一来，网页的首页就会显示Hola!和时间，连到<em>http://localhost:3000/welcome/say_hello</em>的时候也会在底下显示一个「Home」的链接，点下去就会回到首页了。</p>

<h2 id="section-2">设定及建立数据库</h2>

<p>操作数据库是动态网站非常基本的功能，在撰写<em>CRUD</em>应用程序之前，我们必须先设定好数据库。<em>Rails</em>的数据库设定档是<em>config/database.yml</em>，如果你打开这个档案，预设的设定是<em>SQLite3</em>。这个档案裡包含三段不同环境的设定，对应到三个<em>Rails</em>执行环境：</p>

<ul>
  <li>
<em>development</em> 开发模式，用在你的开发的时候</li>
  <li>
<em>test</em> 测试模式，用在执行自动测试时</li>
  <li>
<em>production</em> 正式上线模式，用在实际的上线运作环境</li>
</ul>

<h3 id="sqlite">设定<em>SQLite</em>数据库</h3>

<p><em>Rails</em>内建支持<em><a href="http://www.sqlite.org/">SQLite</a></em>这是一套非常轻量的非服务器型数据库程式，它的数据库就只是一个档案而已。流量大的正式上线环境虽然不适合<em>SQLite</em>，不过拿来开发和测试却非常好用。<em>Rails</em>预设也使用<em>SQLite</em>数据库来建立新的项目，以下是预设的设定资料<em>config/database.yml</em>：</p>

<pre><code># SQLite version 3.x
#   gem install sqlite3
#
#   Ensure the SQLite 3 gem is defined in your Gemfile
#   gem 'sqlite3'
#
default: &amp;default
  adapter: sqlite3
  pool: 5
  timeout: 5000

development:
  &lt;&lt;: *default
  database: db/development.sqlite3

# Warning: The database defined as "test" will be erased and
# re-generated from your development database when you run "rake".
# Do not set this db to the same as development or production.
test:
  &lt;&lt;: *default
  database: db/test.sqlite3

production:
  &lt;&lt;: *default
  database: db/production.sqlite3
</code></pre>

<blockquote>
  <p>中间那段註解告诉你不要把<em>test</em>数据库设成跟<em>production</em>或<em>development</em>同一个</p>
</blockquote>

<p>本书接下来也都使用<em>SQLite</em>数据库，因为它完全不需要什么设定就可以使用。</p>

<blockquote>
  <p><em><a href="http://www.yaml.org/">YAML</a></em>是一种可读性高，用来表达设定资料的资料格式。它严格要求缩排(建议为两个空白)，且冒号后面必须有一个空隔。一般我们会预期<em>YAML</em>的值解析出来是字串，因此如果内容是数字或多行文字时，建议加上引号以避免字串解析错误。例如 <code>password: "123456"</code>。如果没有加上引号，这串数字会被解析成<em>Fixnum</em>对象而不是字串<em>String</em>，后续可能造成型别判断错误。</p>
</blockquote>

<h3 id="section-3">建立数据库</h3>

<p>数据库设定好了，输入以下的指令可以让<em>Rails</em>建立出空的数据库：</p>

<pre><code>$ bin/rake db:create
</code></pre>

<p>这将在<em>db/</em>目录下建立出<em>development</em>和<em>test</em>的<em>SQLite3</em>档案。</p>

<blockquote>
  <p><em>Rake</em>是一种<em>Ruby</em>的命令行工具，你可以输入<code>rake -T</code>列出所有可用的指令。我们会在稍后的章节中详细介绍<em>Rake</em>。</p>
</blockquote>

<h2 id="crud">你的第一个<em>CRUD</em>程式</h2>

<p><em>Rails</em>的<em>scaffold</em>脚手架功能会自动产生一组<em>Model</em>、<em>Views</em>跟<em>Controller</em>程式码，完成一个简易的<em>CRUD</em>程式以供展示及学习之用。请输入：</p>

<pre><code>$ bin/rails g scaffold person name:string bio:text birthday:date
</code></pre>

<p>产生的档案简单说明如下，请注意<em>Model</em>的名称是用单数<em>person</em>，而<em>Controller</em>照<em>RESTful</em>惯例是用复数<em>people</em>：</p>

<table>
<tr>
  <td>db/migrate/20141021135430_create_people.rb</td>
  <td>用来建立people数据库数据表的Migration(你的档案开头名称会有不同的时间)</td>
</tr>
<tr>
  <td>app/models/person.rb</td>
  <td>person model档案</td>
</tr>
<tr>
  <td>app/controllers/people_controller.rb</td>
  <td>people controller档案</td>
</tr>
<tr>
  <td>app/views/people/index.html.erb</td>
  <td>用来显示所有文章的index页面</td>
</tr>
<tr>
  <td>app/views/people/edit.html.erb</td>
  <td>用来编辑文章的页面</td>
</tr>
<tr>
  <td>app/views/people/show.html.erb</td>
  <td>用来显示特定一篇文章的页面</td>
</tr>
<tr>
  <td>app/views/people/new.html.erb</td>
  <td>用来新增文章的页面</td>
</tr>
<tr>
  <td>app/views/people/_form.html.erb</td>
  <td>用来显示编辑和新增文章的表单局部(Partial)样板</td>
</tr>
<tr>
  <td>app/helpers/people_helper.rb</td>
  <td>可在文章Views中使用的Helper方法</td>
</tr>
<tr>
  <td>config/routes.rb</td>
  <td>设定URL路由规则的档案，scaffold再此新增了一行resources :people</td>
</tr>
<tr>
  <td>app/assets/stylesheets/scaffold.css.scss</td>
  <td>Scaffold脚手架提供的样式档案</td>
</tr>
<tr>
  <td>app/assets/stylesheets/people.css.scss</td>
  <td>people的CSS样式档案</td>
</tr>
<tr>
  <td>app/assets/javascripts/people.js.coffee</td>
  <td>people的JavaScript档案</td>
</tr>
</table>

<p>虽然脚手架<em>(scaffolding)</em>可以帮助你快速上手，但是可没办法产生出完美符合需求的程式码。因此有经验的<em>Rails</em>程式设计师甚少使用预设的脚手架产生程式码，而是偏好使用<em>Rails</em>的<em>generator</em>来分别产生<em>Model</em>和<em>Controller</em>档案，甚至定制出自己专属的<em>scaffold</em>程式。</p>

<p><em>scaffold</em>产生出来的程式中，有一项是数据库迁移档<em>(database migration)</em>。<em>Migration</em>的用途是建立和修改数据库数据表。<em>Rails</em>使用<em>rake</em>指令来执行<em>Migrations</em>。<em>Migration</em>的档名中包含了<em>Timestamp</em>(时间戳章)，用来确保它们可以依照建立时间依序执行。</p>

<p>请输入以下指令执行<em>Migration</em>：</p>

<pre><code>$ bin/rake db:migrate
</code></pre>

<p><em>Rails</em>这时会建立<em>people</em>数据表：</p>

<pre><code>==  Createpeople: migrating ====================================================
-- create_table(:people)
   -&gt; 0.0019s
==  Createpeople: migrated (0.0020s) ===========================================
</code></pre>

<p>因为预设是跑在<em>development</em>模式，这个指令会用<em>config/database.yml</em>设定裡的<em>development</em>那段所指定的数据库。</p>

<p>此时浏览<em><a href="http://localhost:3000/people">http://localhost:3000/people</a></em>就可以操作了，十分神奇吧！不过，这里就不详细说明其产生出来的程式码了，读者读毕稍后章节后，自会明白。</p>

<p><img src="images/firststep-scaffold-screenshot.png" alt="Scaffold screenshot"></p>

<h2 id="section-4">常见错误</h2>

<h3 id="nomethoderror">NoMethodError</h3>

<p><em>NoMethodError</em>非常明显，就是你打错方法名称了，例如此例中把<code>link_to</code>打成<code>link_too</code>。根据错误信息你应该可以很容易找到错误是发生在哪个档案、哪一行。</p>

<h3 id="nameerror">NameError</h3>

<p>读取一个不存在、没有初始过的区域变数会出现<em>NameError</em>的错误</p>

<h3 id="syntaxerror-unexpected-end">SyntaxError: unexpected $end</h3>

<p><em>SyntaxError</em>加上<em>unexpected $end, expecting keyword_end</em>的话，那一定是你少了(或多了)<code>end</code>关键字，<code>def</code>跟<code>do</code>都必须要有对应的<code>end</code>。不过很可惜<em>Rails</em>没办法提示你是那一行少了(或多了)<code>end</code>，发生错误的行数都会告诉你是最后一行。如果真的不太好找，你可以单独用<code>ruby -w</code>去执行发生错误的程式，例如<code>ruby -w app/controller/welcome_controller</code>，这会打开<em>Ruby</em>的警告模式来获得更準确的语法错误信息。</p>

        <p><a href="#">》回到页首</a></p>
	     </div>
	</div>
</div>

<div class="footer">
<div class="container">
<p>
<a href="https://ihower.tw/rails4/">Ruby on Rails 实战圣经</a> | Copyright©2014 <a href="https://ihower.tw">Wen-Tien Chang</a>. All Rights Reserved.<br>
除投影片使用<a href="http://creativecommons.org/licenses/by-nc-sa/3.0/tw/">创用 CC 授权</a>释出，文字及图片等内容保留所有权利。<br>
本网页样式来自 <a href="http://guide.couchdb.org/">CouchDB: The Definitive Guide</a>。<br>
本网页最后产生时间：04 Jan 2015
</p>
</div>
</div>
</body>
</html>
