<!DOCTYPE html>
<html>
	<head>
		<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
		<title>Ruby on Rails 實戰聖經 | Rails 起步走</title>
		<link rel="stylesheet" type="text/css" href="./style.css">
		<link rel="canonical" href="https://ihower.tw/rails4/firststep.html">
	</head>
<body>
<div class="container">
    <div class="page_header">
        <h1 class="logo"><a href="./index.html">Ruby on Rails 實戰聖經<span>使用 Rails 4.2 及 Ruby 2.1</span></a></h1>
        <div class="search_box">
            <form class="search" action="https://www.google.com/search">
            <input type="hidden" value="ihower.tw/rails4" name="as_sitesearch">
            <input class="search_field" type="text" value="" name="as_q">
            <input class="search_btn" type="submit" value="Search">
            </form>
        </div>
    </div>

    <div class="notice">
    <p class="inner info_bubble">
      <a href="https://leanpub.com/ihower-rails-book">電子書</a>和簡體版本準備中。如果您有任何意見、鼓勵或勘誤，歡迎<a href="mailto:ihower@gmail.com">來信給我</a>，謝謝。
    </p>
    </div>

    <div class="inner wrap">
       <div class="sidebar">
            <h3><a href="about.html">關於本書</a></h3>
            <h3><a href="index.html">回首頁</a></h3>
       </div>
       <div class="content body">
	      <h1 id="rails-">Rails 起步走</h1>

<blockquote>
  <p>There are two ways of constructing a software design: One way is to make it so simple that there are obviously no deficiencies and the other way is to make it so complicated that there are no obvious deficiencies. - C.A.R. Hoare,</p>
</blockquote>

<p>在這一章中，我們將開始介紹如何建立一個最簡單的<em>Hello, World!</em>程式，以及用最快速的方式製作<em>CRUD</em>應用。</p>

<blockquote>
  <p><em>CRUD</em>指的是<em>Create</em>(新增)、<em>Read</em>(讀取)、<em>Update</em>(更新)、<em>Delete</em>(刪除)四種操作資料的基本方式。</p>
</blockquote>

<p>在上一章安裝<em>Rails</em>後，你會在命令列中得到一個<code>rails</code>的指令，這個指令可以初始一個<em>Rails</em>專案目錄。</p>

<h2 id="rails">開始建立第一個<em>Rails</em>應用程式</h2>

<p>首先請打開一個命令列視窗<em>(Terminal)</em>，然後找個目錄適合放你的<em>Rails</em>專案，就說是<code>projects</code>好了：</p>

<pre><code>$ mkdir projects
$ cd projects
</code></pre>

<p>接著，輸入以下指令就會建立一個叫做<em>demo</em>的<em>Rails</em>專案：</p>

<pre><code>$ rails new demo --skip-test-unit
</code></pre>

<blockquote>
  <p>如果出現建立出來的目錄不是<em>demo</em>而是<em>new</em>，表示你的<em>Rails</em>版本是舊版的，請輸入<code>rails -v</code>檢查<em>Rails</em>的版本必須是<em>3.0</em>以上。不是的話，請回上一章末執行<code>gem install rails</code>安裝<em>Rails 4</em>。</p>
</blockquote>

<p>你會看到以下訊息顯示出總共新增了哪些檔案：</p>

<pre><code>create
create  README
create  Rakefile
create  config.ru
create  .gitignore
create  Gemfile
create  app
...(略)...
create  vendor/plugins
create  vendor/plugins/.gitkeep
</code></pre>

<p>這樣就建立出<em>demo</em>目錄，讓我們繼續：</p>

<pre><code>$ cd demo
</code></pre>

<p>這個目錄下包含了一個<em>Rails</em>專案基本會用到的目錄結構和檔案，讓我們簡單走訪一下，輸入<code>ls</code><em>(Windows讀者請輸入dir)</em>顯示出此目錄下的檔案：</p>

<table>
  <tr>
    <th>檔案/目錄</th>
    <th>用途</th>
  </tr>
  <tr>
    <td>Gemfile</td>
    <td>設定Rails應用程式會使用哪些Gems套件</td>
  </tr>
  <tr>
    <td><span class="caps">README</span></td>
    <td>專案說明：你可以用來告訴其他人你的應用程式是做什麼用的，如何使用等等。 </td>
  </tr>
  <tr>
    <td>Rakefile</td>
    <td>用來載入可以被命令列執行的一些Rake任務</td>
  </tr>
  <tr>
    <td>app/</td>
    <td>放Controllers、Models和Views檔案，接下來的內容主要都在這個目錄。</td>
  </tr>
  <tr>
    <td>config/</td>
    <td>應用程式設定檔、路由規則、資料庫設定等等</td>
  </tr>
  <tr>
    <td>config.ru</td>
    <td>用來啟動應用程式的Rack伺服器設定檔</td>
  </tr>
  <tr>
    <td>db/</td>
    <td>資料庫的結構綱要</td>
  </tr>
  <tr>
    <td>doc/</td>
    <td>用來放你的文件</td>
  </tr>
  <tr>
    <td>lib/</td>
    <td>放一些自定的Module和類別檔案</td>
  </tr>
  <tr>
    <td>log/</td>
    <td>應用程式的Log記錄檔</td>
  </tr>
  <tr>
    <td>public/</td>
    <td>唯一可以在網路上看到的目錄，這是你的圖檔、JavaScript、CSS和其他靜態檔案擺放的地方 </td>
  </tr>
  <tr>
    <td>bin/</td>
    <td>放rails這個指令和放其他的script指令</td>
  </tr>
  <tr>
    <td>test/</td>
    <td>單元測試、fixtures及整合測試等程式</td>
  </tr>
  <tr>
    <td>tmp/</td>
    <td>暫時性的檔案</td>
  </tr>
  <tr>
    <td>vendor/</td>
    <td>用來放第三方程式碼外掛的目錄</td>
  </tr>
</table>

<h2 id="section">啟動伺服器</h2>

<p><em>Rails</em>使用了一套叫做<em>Bundler</em>的工具可以幫助我們檢查及安裝這個<em>Rails</em>應用程式所有依存的套件，請輸入：</p>

<pre><code>$ bundle install
</code></pre>

<blockquote>
  <p>可以只輸入<code>bundle</code>就是<code>bundle install</code>了。
每次有修改<em>Gemfile</em>這個檔案，都需要重新執行<code>bundle</code></p>
</blockquote>

<p>會出現</p>

<pre><code>Fetching source index for http://rubygems.org/
...
Your bundle is complete! Use `bundle show [gemname]` to see where a bundled gem is installed.
</code></pre>

<p>在開發用的電腦上，我們不需要安裝如<em>Apache</em>、<em>IIS</em>的網站伺服器。<em>Ruby</em>本身就有提供了<em>HTTP</em>伺服器可以執行<em>Rails</em>，要啟動它，我們另開啟一個指令視窗，<em>cd</em>進到剛剛建立的<em>Rails</em>專案目錄然後輸入<em>bin/rails server</em>：</p>

<pre><code>$ cd projects/demo
$ bin/rails server
</code></pre>

<p>就會出現以下訊息：</p>

<pre><code>=&gt; Booting WEBrick
=&gt; Rails 4.2.0 application starting in development on http://0.0.0.0:3000
=&gt; Run `rails server -h` for more startup options
=&gt; Notice: server is listening on all interfaces (0.0.0.0). Consider using  127.0.0.1 (--binding option)
=&gt; Ctrl-C to shutdown server
[2014-10-21 21:38:39] INFO  WEBrick 1.3.1
[2014-10-21 21:38:39] INFO  ruby 2.1.5p273 (2014-11-13) [x86_64-darwin13.0]
[2014-10-21 21:38:39] INFO  WEBrick::HTTPServer#start: pid=42535 port=3000
</code></pre>

<blockquote>
  <p>rails server 可以簡寫為 rails s</p>
</blockquote>

<blockquote>
  <p>使用<em>Ubuntu</em>作業系統的朋友，如果啟動伺服器時出現<em>Could not find a JavaScript runtime</em>的錯誤，請編輯<em>Gemfile</em>這個檔案加上一行<code>gem 'therubyracer'</code>，輸入<code>bundle install</code>安裝這個套件，然後再啟動一次<code>rails server</code>即可。這是因為在<em>Ubuntu</em>作業系統上預設沒有任何<em>JavaScript</em>直譯器可以給<em>Rails</em>使用。你可以裝<em>Node.js</em>或是安裝<em>therubyracer</em>這個<em>Ruby</em>套件來獲得<em>JavaScript</em>直譯器。</p>
</blockquote>

<p>接著打開你的瀏覽器前往<em><a href="http://localhost:3000">http://localhost:3000</a></em>，我們可以看到<em>Rails</em>的預設首頁。這個<em>Welcome Aboard</em>的畫面可以確認設定無誤，點選<em>About your application’s environment</em>超連結可以看到更多環境資訊。</p>

<p><img src="images/firststep-welcome-screenshot.png" alt="Welcome screenshot"></p>

<p>要中斷伺服器的話，請按<em>Ctrl+C</em>(若不靈光請改試<em>Ctrl+Z</em>)。在<em>development</em>開發模式的話，除了修改<em>config</em>或<em>vender</em>目錄下的檔案需要重新啟動之外，其他修改通常不需要重新啟動，修改的檔案會自動重新載入。如果是 <em>production</em>正式上線模式的話，修改任何檔案都必須重新啟動伺服器才會有效果。</p>

<h2 id="hello-world">第一個<em>Hello World!!</em>
</h2>

<p>讓程式說<em>Hello World!</em>可是我們學寫程式的一大傳統。我們提過<em>Rails</em>是<em>MVC</em>框架，顯示<em>Hello World!</em>不需要用到資料庫，所以我們只要先寫<em>Controller</em>和<em>View</em>，以及讓路由指派到這個<em>Controller</em>即可，輸入以下指令就會產生出一個叫做<em>welcome</em>的空<em>Controller</em>檔案：</p>

<pre><code>$ bin/rails generate controller welcome
</code></pre>

<blockquote>
  <p>可以簡寫為<code>bin/rails g controller welcome</code></p>
</blockquote>

<p>接下來在路由檔案<em>config/routes.rb</em>新增一行設定：</p>

<pre><code>Rails::Application.routes.draw do
  get "welcome/say_hello" =&gt; "welcome#say"
  # ...
end
</code></pre>

<p><code>get</code>這一行的意思是將<code>http://localhost:3000/welcome/say_hello</code>這樣的網址對應到<em>welcome Controller</em>的<em>say Action</em>。</p>

<p>編輯<em>app/controllers/welcome_controller.rb</em>，加入一個<code>say</code>方法：</p>

<pre><code>class WelcomeController &lt; ApplicationController
  def say
  end
end
</code></pre>

<p>在<em>Controller</em>中，一個公開函式<em>(public method)</em>就代表一個<em>Action</em>，一個<em>Action</em>對應一個<em>HTTP</em>的請求和回應。接著我們打開瀏覽器瀏覽<em>http://localhost:3000/welcome/say_hello</em>，你會看到一個錯誤如下：</p>

<pre><code>Missing template welcome/say, application/say with {:locale=&gt;[:en], :formats=&gt;[:html], :variants=&gt;[], :handlers=&gt;[:erb, :builder, :raw, :ruby, :coffee, :jbuilder]}. Searched in: * "/Users/ihower/projects/demo/app/views"
</code></pre>

<p>這是因為我們還沒有準備好<em>View</em>檔案。請新增<em>app/views/welcome/say.html.erb</em>這個檔案，依照慣例目錄名就是<em>Controller</em>名稱、檔案名是<em>Action</em>名稱，第一個附檔名說明了這是<em>HTML</em>格式的檔案，第二個附檔名說明這是<em>ERb</em>樣板(我們會在<em>View</em>一章仔細介紹樣板)。編輯該檔案內容如下：</p>

<pre><code>&lt;h1&gt;Hello, World!&lt;/h1&gt;
</code></pre>

<p>這時再重新整理一次瀏覽器，你就會看到<em>Hello, World!</em>了。</p>

<p>讓我們再新增一個頁面並加入超連結。再次編輯路由檔案<em>config/routes.rb</em>加入一個路由，變成這樣：</p>

<pre><code>Rails::Application.routes.draw do
  get "welcome/say_hello" =&gt; "welcome#say"
  get "welcome" =&gt; "welcome#index"
  # ...
end
</code></pre>

<p>這一行的意思是將<code>http://localhost:3000/welcome</code>這樣的網址對應到<em>welcome Controller</em>的<em>index Action</em>。
編輯<em>app/controllers/welcome_controller.rb</em>加入</p>

<pre><code>class WelcomeController &lt; ApplicationController

  #...

  def index
  end
end
</code></pre>

<p>新增<em>app/views/welcome/index.html.erb</em>內容是</p>

<pre><code>&lt;p&gt;Hola! It's &lt;%= Time.now %&gt;&lt;/p&gt;
&lt;p&gt;&lt;%= link_to 'Hello!', welcome_say_hello_path %&gt;&lt;/p&gt;
</code></pre>

<p><code>Time</code>是<em>Ruby</em>內建的時間類別，<code>Time.now</code>會輸出目前時間。<code>link_to</code>是<em>Rails</em>內建的方法可以輸出超連結，而<em>welcome_say_hello_path</em>會輸出<code>/welcome/say_hello</code>這個網址。這種出現在<em>View</em>中的輔助方法統稱作<em>Helper</em>。瀏覽<em>http://localhost:3000/welcome</em>，將看到<em>Hola!</em>及<em>Hello!</em>超連結。</p>

<p><img src="images/firststep-hello-screenshot.png" alt="Hello screenshot"></p>

<h3 id="section-1">設定首頁</h3>

<p>如何將網站首頁變更為<em>welcome#index</em>呢？編輯<em>config/routes.rb</em>，加上以下的程式碼，變成這樣：</p>

<pre><code>Rails::Application.routes.draw do
  get "welcome/say_hello" =&gt; "welcome#say"
  get "welcome" =&gt; "welcome#index"

  root :to =&gt; "welcome#index"
  # ...
end
</code></pre>

<blockquote>
  <p><em>Ruby</em>的單行註解是用<code>#</code>井號</p>
</blockquote>

<p>這一行的意思是，將網站根目錄導引至<em>welcome Controller</em>的<em>index Action</em>。那在<em>View</em>中要怎麼建立回首頁的連結呢？編輯<em>app/views/welcome/say.html.erb</em>在Hello, World!下一行加入：</p>

<pre><code>&lt;h1&gt;Hello, World!&lt;/h1&gt;
&lt;p&gt;&lt;%= link_to "Home", root_path %&gt;&lt;/p&gt;
</code></pre>

<p>如此一來，網頁的首頁就會顯示Hola!和時間，連到<em>http://localhost:3000/welcome/say_hello</em>的時候也會在底下顯示一個「Home」的連結，點下去就會回到首頁了。</p>

<h2 id="section-2">設定及建立資料庫</h2>

<p>操作資料庫是動態網站非常基本的功能，在撰寫<em>CRUD</em>應用程式之前，我們必須先設定好資料庫。<em>Rails</em>的資料庫設定檔是<em>config/database.yml</em>，如果你打開這個檔案，預設的設定是<em>SQLite3</em>。這個檔案裡包含三段不同環境的設定，對應到三個<em>Rails</em>執行環境：</p>

<ul>
  <li>
<em>development</em> 開發模式，用在你的開發的時候</li>
  <li>
<em>test</em> 測試模式，用在執行自動測試時</li>
  <li>
<em>production</em> 正式上線模式，用在實際的上線運作環境</li>
</ul>

<h3 id="sqlite">設定<em>SQLite</em>資料庫</h3>

<p><em>Rails</em>內建支援<em><a href="http://www.sqlite.org/">SQLite</a></em>這是一套非常輕量的非伺服器型資料庫程式，它的資料庫就只是一個檔案而已。流量大的正式上線環境雖然不適合<em>SQLite</em>，不過拿來開發和測試卻非常好用。<em>Rails</em>預設也使用<em>SQLite</em>資料庫來建立新的專案，以下是預設的設定資料<em>config/database.yml</em>：</p>

<pre><code># SQLite version 3.x
#   gem install sqlite3
#
#   Ensure the SQLite 3 gem is defined in your Gemfile
#   gem 'sqlite3'
#
default: &amp;default
  adapter: sqlite3
  pool: 5
  timeout: 5000

development:
  &lt;&lt;: *default
  database: db/development.sqlite3

# Warning: The database defined as "test" will be erased and
# re-generated from your development database when you run "rake".
# Do not set this db to the same as development or production.
test:
  &lt;&lt;: *default
  database: db/test.sqlite3

production:
  &lt;&lt;: *default
  database: db/production.sqlite3
</code></pre>

<blockquote>
  <p>中間那段註解告訴你不要把<em>test</em>資料庫設成跟<em>production</em>或<em>development</em>同一個</p>
</blockquote>

<p>本書接下來也都使用<em>SQLite</em>資料庫，因為它完全不需要什麼設定就可以使用。</p>

<blockquote>
  <p><em><a href="http://www.yaml.org/">YAML</a></em>是一種可讀性高，用來表達設定資料的資料格式。它嚴格要求縮排(建議為兩個空白)，且冒號後面必須有一個空隔。一般我們會預期<em>YAML</em>的值解析出來是字串，因此如果內容是數字或多行文字時，建議加上引號以避免字串解析錯誤。例如 <code>password: "123456"</code>。如果沒有加上引號，這串數字會被解析成<em>Fixnum</em>物件而不是字串<em>String</em>，後續可能造成型別判斷錯誤。</p>
</blockquote>

<h3 id="section-3">建立資料庫</h3>

<p>資料庫設定好了，輸入以下的指令可以讓<em>Rails</em>建立出空的資料庫：</p>

<pre><code>$ bin/rake db:create
</code></pre>

<p>這將在<em>db/</em>目錄下建立出<em>development</em>和<em>test</em>的<em>SQLite3</em>檔案。</p>

<blockquote>
  <p><em>Rake</em>是一種<em>Ruby</em>的命令列工具，你可以輸入<code>rake -T</code>列出所有可用的指令。我們會在稍後的章節中詳細介紹<em>Rake</em>。</p>
</blockquote>

<h2 id="crud">你的第一個<em>CRUD</em>程式</h2>

<p><em>Rails</em>的<em>scaffold</em>鷹架功能會自動產生一組<em>Model</em>、<em>Views</em>跟<em>Controller</em>程式碼，完成一個簡易的<em>CRUD</em>程式以供展示及學習之用。請輸入：</p>

<pre><code>$ bin/rails g scaffold person name:string bio:text birthday:date
</code></pre>

<p>產生的檔案簡單說明如下，請注意<em>Model</em>的名稱是用單數<em>person</em>，而<em>Controller</em>照<em>RESTful</em>慣例是用複數<em>people</em>：</p>

<table>
<tr>
  <td>db/migrate/20141021135430_create_people.rb</td>
  <td>用來建立people資料庫資料表的Migration(你的檔案開頭名稱會有不同的時間)</td>
</tr>
<tr>
  <td>app/models/person.rb</td>
  <td>person model檔案</td>
</tr>
<tr>
  <td>app/controllers/people_controller.rb</td>
  <td>people controller檔案</td>
</tr>
<tr>
  <td>app/views/people/index.html.erb</td>
  <td>用來顯示所有文章的index頁面</td>
</tr>
<tr>
  <td>app/views/people/edit.html.erb</td>
  <td>用來編輯文章的頁面</td>
</tr>
<tr>
  <td>app/views/people/show.html.erb</td>
  <td>用來顯示特定一篇文章的頁面</td>
</tr>
<tr>
  <td>app/views/people/new.html.erb</td>
  <td>用來新增文章的頁面</td>
</tr>
<tr>
  <td>app/views/people/_form.html.erb</td>
  <td>用來顯示編輯和新增文章的表單局部(Partial)樣板</td>
</tr>
<tr>
  <td>app/helpers/people_helper.rb</td>
  <td>可在文章Views中使用的Helper方法</td>
</tr>
<tr>
  <td>config/routes.rb</td>
  <td>設定URL路由規則的檔案，scaffold再此新增了一行resources :people</td>
</tr>
<tr>
  <td>app/assets/stylesheets/scaffold.css.scss</td>
  <td>Scaffold鷹架提供的樣式檔案</td>
</tr>
<tr>
  <td>app/assets/stylesheets/people.css.scss</td>
  <td>people的CSS樣式檔案</td>
</tr>
<tr>
  <td>app/assets/javascripts/people.js.coffee</td>
  <td>people的JavaScript檔案</td>
</tr>
</table>

<p>雖然鷹架<em>(scaffolding)</em>可以幫助你快速上手，但是可沒辦法產生出完美符合需求的程式碼。因此有經驗的<em>Rails</em>程式設計師甚少使用預設的鷹架產生程式碼，而是偏好使用<em>Rails</em>的<em>generator</em>來分別產生<em>Model</em>和<em>Controller</em>檔案，甚至客製出自己專屬的<em>scaffold</em>程式。</p>

<p><em>scaffold</em>產生出來的程式中，有一項是資料庫遷移檔<em>(database migration)</em>。<em>Migration</em>的用途是建立和修改資料庫資料表。<em>Rails</em>使用<em>rake</em>指令來執行<em>Migrations</em>。<em>Migration</em>的檔名中包含了<em>Timestamp</em>(時間戳章)，用來確保它們可以依照建立時間依序執行。</p>

<p>請輸入以下指令執行<em>Migration</em>：</p>

<pre><code>$ bin/rake db:migrate
</code></pre>

<p><em>Rails</em>這時會建立<em>people</em>資料表：</p>

<pre><code>==  Createpeople: migrating ====================================================
-- create_table(:people)
   -&gt; 0.0019s
==  Createpeople: migrated (0.0020s) ===========================================
</code></pre>

<p>因為預設是跑在<em>development</em>模式，這個指令會用<em>config/database.yml</em>設定裡的<em>development</em>那段所指定的資料庫。</p>

<p>此時瀏覽<em><a href="http://localhost:3000/people">http://localhost:3000/people</a></em>就可以操作了，十分神奇吧！不過，這裡就不詳細說明其產生出來的程式碼了，讀者讀畢稍後章節後，自會明白。</p>

<p><img src="images/firststep-scaffold-screenshot.png" alt="Scaffold screenshot"></p>

<h2 id="section-4">常見錯誤</h2>

<h3 id="nomethoderror">NoMethodError</h3>

<p><em>NoMethodError</em>非常明顯，就是你打錯方法名稱了，例如此例中把<code>link_to</code>打成<code>link_too</code>。根據錯誤訊息你應該可以很容易找到錯誤是發生在哪個檔案、哪一行。</p>

<h3 id="nameerror">NameError</h3>

<p>讀取一個不存在、沒有初始過的區域變數會出現<em>NameError</em>的錯誤</p>

<h3 id="syntaxerror-unexpected-end">SyntaxError: unexpected $end</h3>

<p><em>SyntaxError</em>加上<em>unexpected $end, expecting keyword_end</em>的話，那一定是你少了(或多了)<code>end</code>關鍵字，<code>def</code>跟<code>do</code>都必須要有對應的<code>end</code>。不過很可惜<em>Rails</em>沒辦法提示你是那一行少了(或多了)<code>end</code>，發生錯誤的行數都會告訴你是最後一行。如果真的不太好找，你可以單獨用<code>ruby -w</code>去執行發生錯誤的程式，例如<code>ruby -w app/controller/welcome_controller</code>，這會打開<em>Ruby</em>的警告模式來獲得更準確的語法錯誤訊息。</p>

        <p><a href="#">》回到頁首</a></p>
	     </div>
	</div>
</div>

<div class="footer">
<div class="container">
<p>
<a href="https://ihower.tw/rails4/">Ruby on Rails 實戰聖經</a> | Copyright©2014 <a href="https://ihower.tw">Wen-Tien Chang</a>. All Rights Reserved.<br>
除投影片使用<a href="http://creativecommons.org/licenses/by-nc-sa/3.0/tw/">創用 CC 授權</a>釋出，文字及圖片等內容保留所有權利。<br>
本網頁樣式來自 <a href="http://guide.couchdb.org/">CouchDB: The Definitive Guide</a>。<br>
本網頁最後產生時間：04 Jan 2015
</p>
</div>
</div>
</body>
</html>
